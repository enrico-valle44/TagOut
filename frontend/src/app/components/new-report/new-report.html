<div class="new-report-container">
    
    <div class="back-button-container">
        <button mat-button class="back-button" (click)="goBack()">
        <mat-icon>arrow_back</mat-icon>
        Indietro
        </button>
        <div class="location-button">
            <button mat-icon-button (click)="getCurrentPosition()">
                <mat-icon>my_location</mat-icon>
            </button>
            <button mat-icon-button (click)="showMapPicker = true">
                <mat-icon>near_me</mat-icon>
            </button>
        </div>
    </div>


    <form class="report-form" [formGroup]="reportForm" (ngSubmit)="postReport()">
        <mat-form-field class="input-full-width">
            <mat-label>Titolo</mat-label>
            <input matInput type="text" formControlName="title" placeholder="Report Title" /> 
        </mat-form-field>
        
        <mat-form-field class="input-full-width">
            <mat-label>Descrizione</mat-label>    
            <textarea matInput formControlName="description" placeholder="Report Description"></textarea>
        </mat-form-field>
        
        <div class="cat-container" formArrayName="categories">
            @for (category of categories.controls; track category; let i = $index) {
                <div class="category-item">
                    <mat-form-field>
                        <mat-label>Categoria</mat-label>
                        <mat-select [formControlName]="i">
                            @for (name of categoryNames; track $index) {
                                <mat-option value="{{name}}">{{name}}</mat-option>
                            }
                        </mat-select>
                    </mat-form-field>
                </div>
                
                
                <!--<button matButton="tonal" type="button" (click)="removeCategoryInput(i)">
                    <mat-icon>delete</mat-icon>
                </button>-->
            }
            <!--<button matButton="tonal" type="button" (click)="addCategoryInput()">
                <mat-icon>add</mat-icon>
            </button>-->
        </div>
        
        <div class="img-container">
            
            <!--<div class="gallery">
                @for(image of images; track $index){
                    <img src="{{image}}" alt="">
                    }
                </div>-->
                
                <div class="gallery">
                    @for(image of images; track $index){
                        <div class="image-wrapper">
                            <img src="{{image}}" alt="">
                            <button type="button" class="remove-btn" (click)="removeImage($index)">
                                <mat-icon>close</mat-icon>
                            </button>
                        </div>
                    }
                </div>
                
                <button matButton="tonal" type="button" (click)="fileInput.click()">
                    <mat-icon>photo_camera</mat-icon>
                    Scatta o scegli foto
                </button>
                
                <input
                type="file"
                accept="image/*"
                capture="environment"
                #fileInput
                hidden
                (change)="onImageSelected($event)"
                />
            </div>
            
            <button matButton="tonal" [disabled]="!reportForm.valid || images.length===0 || !hasSelectedCategory()" type="submit">Invia</button>
        </form>
        <div style="color: red;">
            @if(showNoPositionMsg){
                <h2>Seleziona prima una posizione!</h2>
            }
        </div>
        <div>
            @if(showMapPicker) {
                <app-map-picker (positionSelected)="onPositionSelected($event)"></app-map-picker>
            }
        </div>
    </div>
        